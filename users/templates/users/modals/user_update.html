{% load crispy_forms_tags %}
{% load access_controls %}

{% onlyadmins %}
    <!-- Modal -->
    <div class="modal fade" id="user-update-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn close fs-5" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if not user_update_form.is_bound and not set_password_form.is_bound or user_update_form.is_bound %} active {% endif %}"
                                    id="bio-update-tab" data-bs-toggle="tab" data-bs-target="#bio"
                                    type="button"
                                    role="tab">Edit Bio
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if set_password_form.is_bound %} active {% endif %}"
                                    id="password-update-tab" data-bs-toggle="tab"
                                    data-bs-target="#set-new-password" type="button"
                                    role="tab">Set New Password
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show {% if not user_update_form.is_bound and not set_password_form.is_bound or user_update_form.is_bound %} active {% endif %}"
                             id="bio" role="tabpanel">
                            <form class="p-3" method="post" {% if user_update_form.is_bound %} action="{{ reqeust.path_info }}" {% endif %}>
                                {% csrf_token %}
                                {{ user_update_form | crispy }}
                                <div class="form-group d-grid px-0">
                                    <button class="btn btn-primary" type="submit">Save</button>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade show {% if set_password_form.is_bound %} active {% endif %}"
                             id="set-new-password" role="tabpanel">
                            <form class="mt-3" method="post" {% if set_password_form.is_bound %} action="{{ reqeust.path_info }}" {% endif %}>
                                {% csrf_token %}
                                {{ set_password_form | crispy }}
                                <div class="form-group d-grid px-0">
                                    <button class="btn btn-primary" type="submit">Change
                                        password
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if user_update_form.errors or set_password_form.errors %}
        <script>
            bootstrap.Modal.getOrCreateInstance(document.getElementById("user-update-modal")).show();
        </script>
    {% endif %}
    <script>
        document.getElementById("user-update-modal").addEventListener("shown.bs.modal", function(event) {
            {# Bio update form submit url and the set password url differ only by the GET param 'scope' #}
            const bio_form_submit_url = event.target.querySelector("#bio form").action
            event.target.querySelector("#set-new-password form").action = `${bio_form_submit_url}?scope=pwd`;
        });
    </script>
{% endonlyadmins %}
